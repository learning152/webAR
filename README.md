# WebAR 粒子互动系统

基于 Three.js 和 MediaPipe Hands 的 WebAR 粒子互动系统，使用 React + TypeScript 构建。支持实时手势识别、动态粒子数量调整、实心3D形态渲染，以及摄像头降级模式下的手势模拟器。

## 项目结构

```
src/
├── components/     # React 组件（ParticleCanvas、GestureSimulator、UIControls）
├── engines/        # 核心引擎（Three.js、物理引擎、手势识别、交互管理）
├── shapes/         # 形状生成器（支持表面和体积采样）
├── config/         # 配置文件（形态配置、优化配置）
├── utils/          # 工具函数（摄像头管理、性能监控、库加载）
└── test/           # 测试配置和工具
```

## 技术栈

- **框架**: React 18 + TypeScript
- **构建工具**: Vite
- **3D 渲染**: Three.js（通过 CDN 动态加载）
- **手势识别**: MediaPipe Hands（通过 CDN 动态加载）
- **测试框架**: Vitest + fast-check（属性测试）
- **测试库**: @testing-library/react + jsdom
- **CDN**: unpkg.com
- **开发工具**: Kiro AI IDE

## 架构设计

### 核心引擎

1. **ThreeEngine** - Three.js 渲染引擎
   - 场景、相机、渲染器管理
   - 粒子几何体和材质系统
   - 动态重初始化支持
   - 场景旋转和缩放控制

2. **PhysicsEngine** - 物理模拟引擎
   - 基于 Float32Array 的高性能粒子数据存储
   - 速度积分和加速度积分
   - 力系统（目标吸引、阻尼、爆炸力）
   - 动态重初始化和形态类型保持

3. **GestureEngine** - 手势识别引擎
   - MediaPipe Hands 集成
   - 手部关键点提取和分析
   - 手势分类器（6种手势）
   - 手部速度和旋转计算

4. **InteractionManager** - 交互管理器
   - 挥手风暴检测和力施加
   - 深度推拉缩放控制
   - 爆炸过渡特效协调
   - 行星跟随逻辑

5. **ShapeGenerator** - 形状生成器
   - 表面采样算法（原有功能）
   - 体积采样算法（新增功能）
   - 粒子多样性生成
   - 密度控制策略

### 设计模式

- **状态机模式**: GestureStateMachine 管理手势状态转换
- **策略模式**: 不同形状使用不同的采样策略
- **观察者模式**: 手势变化触发粒子系统响应
- **工厂模式**: ShapeGenerator 生成不同形状的粒子配置

## 快速开始

```bash
# 1. 克隆项目
git clone <repository-url>
cd webar-particle-interaction

# 2. 安装依赖
npm install

# 3. 启动开发服务器
npm run dev

# 4. 在浏览器中打开 http://localhost:5173
# 允许摄像头权限以使用手势识别功能
# 或使用手势模拟器进行交互
```

## 开发命令

```bash
# 安装依赖
npm install

# 启动开发服务器（默认端口 5173）
npm run dev

# 构建生产版本
npm run build

# 运行所有测试（单次运行）
npm test

# 运行测试（监听模式，开发时使用）
npm run test:watch

# 预览生产构建
npm run preview
```

## 使用说明

### 摄像头模式
1. 启动应用后，允许浏览器访问摄像头
2. 将手放在摄像头前，系统会自动识别手势
3. 尝试不同的手势来切换粒子形态：
   - 张手 → 球体（行星）
   - 剪刀手 → 文字
   - 握拳 → 圆环
   - 食指 → 星形
   - 竖大拇指 → 爱心
   - 手指比心 → 一箭穿心
4. 快速挥手产生风暴效果
5. 手掌靠近/远离摄像头控制缩放

### 手势模拟器模式
1. 如果摄像头不可用，系统会自动显示手势模拟器
2. 点击形态按钮切换粒子形态
3. 使用方向键（↑↓←→）旋转场景
4. 拖动缩放滑块调整场景大小
5. 可随时点击"打开模拟器"/"关闭模拟器"按钮切换模式

### UI 控制面板
- **粒子数量滑块**: 动态调整粒子数量（100 - 20,000）
- **FPS 显示**: 实时显示帧率
- **手势状态**: 显示当前识别的手势

## 功能特性

### 核心功能
- **动态粒子系统**: 支持运行时调整粒子数量（默认 16,000 个），无需重新加载页面
- **实心3D形态渲染**: 粒子采用体积采样算法，形成真实的3D实心形状
  - 球体（行星）：使用 r³ 分布的体积采样
  - 爱心：基于3D隐式方程的拒绝采样
  - 星形：2D星形轮廓 + 深度dome效果
  - 圆环：环面参数方程的体积采样
  - 一箭穿心：组合形态（70%爱心 + 30%箭矢）
- **粒子多样性**: 每个粒子具有独特的大小、形状（5种几何体）和颜色变化
- **智能密度控制**: 根据粒子数量自动调整表面/内部粒子比例
  - 低粒子数（<1000）：70% 表面粒子，确保轮廓清晰
  - 高粒子数（>5000）：40% 表面粒子，展现内部密度
- **基于物理的粒子运动**: 速度积分、加速度积分、阻尼系统、目标吸引力
- **6种手势识别**: 张手、剪刀手、握拳、食指、竖大拇指、手指比心
- **交互特效**:
  - 挥手风暴：快速挥手产生粒子风暴效果
  - 深度推拉：手掌大小控制场景缩放
  - 爆炸过渡：形态切换时的爆炸重组特效
  - 行星跟随：行星形态跟随手部位置和旋转

### 手势模拟器（降级模式）
当摄像头不可用时，系统自动启用手势模拟器，提供完整的交互体验：

- **形态切换**: 点击按钮在 6 种粒子形态间切换
- **旋转控制**: 使用方向键（↑↓←→）旋转粒子场景，支持组合键同时旋转
- **缩放控制**: 滑块控制缩放比例，支持 1x/3x/5x 倍数切换
- **自动降级**: 摄像头初始化失败时自动显示模拟器面板
- **手动切换**: 可随时手动打开/关闭模拟器
- **优先级控制**: 模拟器激活时暂停摄像头手势检测，关闭后自动恢复

### 摄像头功能
- 非阻塞式摄像头初始化
- 摄像头重试功能
- 实时手势识别与粒子交互（基于 MediaPipe Hands）

## 开发进度

### ✅ 已完成的功能模块

1. **WebAR 粒子交互基础系统** (webar-particle-interaction)
   - 完整的粒子物理引擎和渲染系统
   - 6种手势识别和形态变换
   - 挥手风暴、深度推拉、爆炸过渡特效
   - 外部库动态加载（Three.js、MediaPipe Hands）
   - 性能监控和优化

2. **手势模拟器降级模式** (gesture-simulator-fallback)
   - 形态配置模块和动态按钮生成
   - 键盘旋转控制和缩放滑块
   - 自动降级和手动切换
   - 优先级控制逻辑

3. **动态粒子数量调整** (dynamic-particle-count)
   - ThreeEngine 动态重初始化
   - PhysicsEngine 动态重初始化
   - 场景状态保持（旋转、缩放、形态类型）
   - 性能优化（相同数量跳过重初始化）

4. **实心3D形态渲染** (solid-3d-shapes)
   - 5种形状的体积采样算法
   - 粒子多样性系统（大小、形状、颜色）
   - 智能密度控制策略
   - 5种几何体类型（球体、立方体、四面体、八面体、圆环）

### 🚧 进行中的功能

- 实心3D形态渲染的最终测试和优化（任务 12）

### 📋 规划中的功能

- 更多交互手势和特效
- 性能优化和移动端适配
- 更多粒子形态和过渡效果

## 开发方法论

本项目采用 **Spec-Driven Development（规范驱动开发）** 方法论，使用 Kiro AI IDE 的 Specs 功能：

### Specs 工作流程

每个功能模块都遵循以下开发流程：

1. **需求文档** (requirements.md)
   - 使用 EARS 模式编写需求
   - 遵循 INCOSE 语义质量规则
   - 包含用户故事和验收标准

2. **设计文档** (design.md)
   - 架构设计和组件接口
   - 数据模型和错误处理
   - **正确性属性**（Correctness Properties）
   - 测试策略（单元测试 + 属性测试）

3. **任务列表** (tasks.md)
   - 可执行的实现任务
   - 每个任务关联具体需求
   - 属性测试任务标注验证的正确性属性

### 属性测试驱动

项目使用 **Property-Based Testing (PBT)** 确保软件正确性：

- 每个验收标准都被转化为可测试的正确性属性
- 使用 fast-check 库生成随机测试数据
- 每个属性测试运行至少 100 次迭代
- 测试覆盖边界情况和异常输入

### Specs 目录结构

```
.kiro/specs/
├── webar-particle-interaction/    # 基础粒子交互系统
│   ├── requirements.md
│   ├── design.md
│   └── tasks.md
├── gesture-simulator-fallback/     # 手势模拟器降级模式
│   ├── requirements.md
│   ├── design.md
│   └── tasks.md
├── dynamic-particle-count/         # 动态粒子数量调整
│   ├── requirements.md
│   ├── design.md
│   └── tasks.md
└── solid-3d-shapes/                # 实心3D形态渲染
    ├── requirements.md
    ├── design.md
    └── tasks.md
```

## 浏览器支持

- Chrome/Edge (推荐) - 完整支持
- Firefox - 完整支持
- Safari - 需要测试 MediaPipe Hands 兼容性

## 贡献指南

### 添加新功能

1. **创建 Spec**
   - 在 `.kiro/specs/` 下创建新的功能目录
   - 编写 requirements.md（需求文档）
   - 编写 design.md（设计文档，包含正确性属性）
   - 编写 tasks.md（任务列表）

2. **实现功能**
   - 按照 tasks.md 中的任务顺序实现
   - 为每个正确性属性编写属性测试
   - 编写必要的单元测试

3. **测试验证**
   - 运行 `npm test` 确保所有测试通过
   - 手动测试功能的用户体验
   - 检查性能指标（FPS）

4. **代码审查**
   - 确保代码符合 TypeScript 最佳实践
   - 确保测试覆盖率充分
   - 更新 README.md 文档

### 代码规范

- 使用 TypeScript 严格模式
- 遵循函数式编程原则（尽可能使用纯函数）
- 使用有意义的变量和函数命名
- 添加必要的代码注释
- 每个属性测试必须标注验证的正确性属性

### 测试规范

- 单元测试：测试具体示例和边界情况
- 属性测试：测试通用规则和不变量
- 集成测试：测试组件间的交互
- 每个属性测试至少运行 100 次迭代

## 性能优化

### 已实现的优化

- 使用 Float32Array 存储粒子数据（内存效率）
- 手势识别节流（20 FPS）
- 动态粒子数量调整
- WebGL 上下文丢失恢复
- 性能监控和自动降级

### 性能指标

- 目标 FPS: 60
- 降级阈值: FPS < 20
- 默认粒子数: 16,000
- 最大粒子数: 20,000

## 故障排除

### 摄像头无法访问
- 检查浏览器权限设置
- 确保使用 HTTPS 或 localhost
- 尝试使用手势模拟器模式

### 性能问题
- 降低粒子数量（使用 UI 滑块）
- 关闭其他占用 GPU 的应用
- 使用性能更好的浏览器（Chrome/Edge）

### 手势识别不准确
- 确保光线充足
- 保持手部在摄像头视野内
- 避免复杂背景干扰

## 许可证

MIT License

## 致谢

- Three.js - 3D 渲染引擎
- MediaPipe Hands - 手势识别
- fast-check - 属性测试框架
- Kiro AI - 开发工具和 Spec-Driven Development 支持

## 测试覆盖

项目使用 Vitest + fast-check 进行全面的单元测试和属性测试：

### 属性测试（Property-Based Testing）
- **粒子系统**: 初始化完整性、速度积分、加速度积分、力应用、阻尼效果
- **动态粒子数量**: 几何体缓冲区大小、物理数组大小、场景状态保持、重初始化优化
- **形状生成器**: 
  - 体积分布验证（球体、爱心、星形、圆环、一箭穿心）
  - 粒子多样性（大小、形状类型、颜色变化）
  - 密度控制策略（表面优先、内部密度）
- **手势识别**: 手指状态分析、手部速度计算、手部旋转计算
- **交互系统**: 挥手风暴触发、深度推拉缩放、爆炸过渡、行星跟随
- **手势模拟器**: 形态配置回退、旋转变换、缩放映射、形态按钮一致性、控制优先级

### 单元测试
- 库加载器（LibraryLoader）
- 摄像头管理器（CameraManager）
- 性能监控（PerformanceMonitor）
- 手势引擎（GestureEngine）
- 手势状态机（GestureStateMachine）
- Three.js 渲染引擎（ThreeEngine）
- React 组件（ParticleCanvas、GestureSimulator、UIControls、App）

### 集成测试
- 降级模式完整流程
- 模拟器与引擎交互
- 粒子系统端到端测试
